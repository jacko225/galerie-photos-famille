<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.png">
  <title>Photos Famille</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900">
  <div id="app"></div>

  <script>
    class App {
      constructor() {
        this.albums = [];
        this.currentAlbum = null;
        this.selectedPhoto = null;
        this.showNewAlbum = false;
        this.load();
        setInterval(() => this.load(), 3000);
      }

      async load() {
        const data = localStorage.getItem('shared_family-albums');
        if (data) this.albums = JSON.parse(data);
        this.render();
      }

      async save() {
        localStorage.setItem('shared_family-albums', JSON.stringify(this.albums));
        this.render();
      }

      createAlbum() {
        const input = document.getElementById('newAlbumInput');
        const name = input.value.trim();
        if (!name) return alert('Entrez un nom');
        
        this.albums.push({
          id: Date.now().toString(),
          name: name,
          photos: []
        });
        this.save();
        this.showNewAlbum = false;
      }

      deleteAlbum(id) {
        if (!confirm('Supprimer cet album ?')) return;
        this.albums = this.albums.filter(a => a.id !== id);
        this.save();
      }

      openAlbum(id) {
        this.currentAlbum = this.albums.find(a => a.id === id);
        this.render();
      }

      closeAlbum() {
        this.currentAlbum = null;
        this.render();
      }

      uploadPhotos(files, albumId) {
        Array.from(files).forEach(file => {
          if (file.size > 5000000) return alert(file.name + ' trop gros');
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const album = this.albums.find(a => a.id === albumId);
            if (!album) return;
            
            album.photos.push({
              id: Date.now().toString() + Math.random(),
              data: e.target.result,
              name: file.name
            });
            this.save();
            this.currentAlbum = album;
          };
          reader.readAsDataURL(file);
        });
      }

      openPhoto(photoId) {
        this.selectedPhoto = this.currentAlbum.photos.find(p => p.id === photoId);
        this.render();
      }

      closePhoto() {
        this.selectedPhoto = null;
        this.render();
      }

      deletePhoto(photoId) {
        if (!confirm('Supprimer ?')) return;
        this.currentAlbum.photos = this.currentAlbum.photos.filter(p => p.id !== photoId);
        const album = this.albums.find(a => a.id === this.currentAlbum.id);
        album.photos = this.currentAlbum.photos;
        this.save();
        this.selectedPhoto = null;
      }

      render() {
        const app = document.getElementById('app');

        // Photo plein √©cran
        if (this.selectedPhoto) {
          const idx = this.currentAlbum.photos.findIndex(p => p.id === this.selectedPhoto.id);
          app.innerHTML = `
            <div class="fixed inset-0 bg-black flex flex-col">
              <div class="p-4 bg-slate-900 flex justify-between items-center">
                <button onclick="app.closePhoto()" class="text-white px-4 py-2 bg-slate-700 rounded">‚úï Fermer</button>
                <button onclick="app.deletePhoto('${this.selectedPhoto.id}')" class="text-red-400 px-4 py-2 bg-slate-700 rounded">üóëÔ∏è</button>
              </div>
              <div class="flex-1 flex items-center justify-center p-4">
                <img src="${this.selectedPhoto.data}" class="max-h-full max-w-full rounded">
              </div>
              <div class="p-4 bg-slate-900 flex justify-center gap-4 text-white">
                <button onclick="app.prevPhoto()" ${idx === 0 ? 'disabled' : ''} class="px-4 py-2 bg-slate-700 rounded disabled:opacity-30">‚Üê Pr√©c</button>
                <span class="py-2">${idx + 1} / ${this.currentAlbum.photos.length}</span>
                <button onclick="app.nextPhoto()" ${idx >= this.currentAlbum.photos.length - 1 ? 'disabled' : ''} class="px-4 py-2 bg-slate-700 rounded disabled:opacity-30">Suiv ‚Üí</button>
              </div>
            </div>
          `;
          return;
        }

        // Vue album
        if (this.currentAlbum) {
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
              <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                  <button onclick="app.closeAlbum()" class="text-white px-4 py-2 bg-slate-700 rounded">‚Üê Retour</button>
                  <label class="px-6 py-3 bg-blue-600 text-white rounded cursor-pointer hover:bg-blue-500">
                    üì§ Ajouter
                    <input type="file" multiple accept="image/*" class="hidden" onchange="app.uploadPhotos(this.files, '${this.currentAlbum.id}')">
                  </label>
                </div>
                
                <h1 class="text-3xl font-bold text-white mb-2">${this.currentAlbum.name}</h1>
                <p class="text-slate-400 mb-8">${this.currentAlbum.photos.length} photo(s)</p>

                ${this.currentAlbum.photos.length === 0 ? `
                  <div class="text-center py-20 text-slate-400">
                    <div class="text-6xl mb-4">üì∑</div>
                    <p>Aucune photo</p>
                  </div>
                ` : `
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${this.currentAlbum.photos.map(p => `
                      <div onclick="app.openPhoto('${p.id}')" class="aspect-square bg-slate-800 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-500">
                        <img src="${p.data}" class="w-full h-full object-cover">
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          `;
          return;
        }

        // Liste albums
        app.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
            <div class="max-w-7xl mx-auto">
              <div class="flex justify-between items-center mb-8">
                <div>
                  <h1 class="text-4xl font-bold text-white mb-2">Albums Famille ‚òÅÔ∏è</h1>
                  <p class="text-slate-400">Synchronis√©s en temps r√©el</p>
                </div>
                <button onclick="app.toggleNewAlbum()" class="px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-500">
                  ‚ûï Nouvel album
                </button>
              </div>

              ${this.showNewAlbum ? `
                <div class="mb-8 p-6 bg-slate-800 rounded-lg">
                  <h3 class="text-xl text-white mb-4">Cr√©er un album</h3>
                  <div class="flex gap-3">
                    <input id="newAlbumInput" type="text" placeholder="Nom de l'album" 
                      class="flex-1 px-4 py-3 bg-slate-900 text-white rounded border border-slate-700"
                      onkeypress="if(event.key==='Enter') app.createAlbum()">
                    <button onclick="app.createAlbum()" class="px-6 py-3 bg-blue-600 text-white rounded">Cr√©er</button>
                    <button onclick="app.toggleNewAlbum()" class="px-6 py-3 bg-slate-700 text-white rounded">Annuler</button>
                  </div>
                </div>
              ` : ''}

              ${this.albums.length === 0 ? `
                <div class="text-center py-20 text-slate-400">
                  <div class="text-6xl mb-4">üìÅ</div>
                  <p class="text-xl">Aucun album</p>
                </div>
              ` : `
                <div class="grid md:grid-cols-3 gap-6">
                  ${this.albums.map(a => `
                    <div onclick="app.openAlbum('${a.id}')" class="bg-slate-800 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-500">
                      <div class="aspect-video bg-slate-900 flex items-center justify-center text-6xl">
                        ${a.photos.length > 0 ? `<img src="${a.photos[0].data}" class="w-full h-full object-cover">` : 'üì∑'}
                      </div>
                      <div class="p-4">
                        <h3 class="text-xl font-bold text-white">${a.name}</h3>
                        <p class="text-slate-400 text-sm">${a.photos.length} photo(s)</p>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        `;

        if (this.showNewAlbum) {
          setTimeout(() => document.getElementById('newAlbumInput')?.focus(), 100);
        }
      }

      toggleNewAlbum() {
        this.showNewAlbum = !this.showNewAlbum;
        this.render();
      }

      prevPhoto() {
        const idx = this.currentAlbum.photos.findIndex(p => p.id === this.selectedPhoto.id);
        if (idx > 0) {
          this.selectedPhoto = this.currentAlbum.photos[idx - 1];
          this.render();
        }
      }

      nextPhoto() {
        const idx = this.currentAlbum.photos.findIndex(p => p.id === this.selectedPhoto.id);
        if (idx < this.currentAlbum.photos.length - 1) {
          this.selectedPhoto = this.currentAlbum.photos[idx + 1];
          this.render();
        }
      }
    }

    const app = new App();
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
